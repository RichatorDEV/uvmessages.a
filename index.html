<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>UV Messages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
        .sidebar { 
            height: 100%; width: 0; position: fixed; top: 0; left: 0; 
            background: #2c3e50; overflow-x: hidden; transition: 0.5s; padding-top: 60px; 
        }
        .sidebar a, .sidebar button { 
            padding: 10px 15px; display: block; color: white; text-decoration: none; border: none; background: none; width: 100%; text-align: left; cursor: pointer; 
        }
        .sidebar a:hover, .sidebar button:hover { background: #34495e; }
        .main { margin-left: 0; transition: 0.5s; padding: 20px; }
        .openbtn { font-size: 20px; cursor: pointer; background: #2c3e50; color: white; padding: 10px 15px; border: none; position: fixed; top: 10px; left: 10px; display: none; }
        .auth-section, .messaging-section, .settings-section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
        .hidden { display: none; }
        .contacts { margin-top: 20px; }
        .contact { display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd; position: relative; }
        .contact:hover { background: #f0f0f0; }
        .contact img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .notification { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
            background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; 
            text-align: center; line-height: 20px; font-size: 12px; 
        }
        .messages { margin-top: 20px; height: 400px; overflow-y: auto; }
        .message { display: flex; align-items: center; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .message.sent { background: #e9ecef; justify-content: flex-start; }
        .message.received { background: #d4edda; justify-content: flex-end; }
        .message img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div id="sidebar" class="sidebar hidden">
        <a href="#" onclick="showMessaging()">Mensajería</a>
        <a href="#" onclick="showSettings()">Configuración</a>
        <button onclick="logout()">Cerrar Sesión</button>
    </div>

    <div id="main" class="main">
        <button id="openbtn" class="openbtn" onclick="toggleSidebar()">☰</button>

        <div class="auth-section" id="authSection">
            <h2>UV Messages</h2>
            <div id="registerForm">
                <h3>Registro</h3>
                <input type="text" id="regUsername" placeholder="Nombre de usuario"><br>
                <input type="password" id="regPassword" placeholder="Contraseña"><br>
                <button onclick="register()">Registrar</button>
            </div>
            <div id="loginForm">
                <h3>Iniciar Sesión</h3>
                <input type="text" id="loginUsername" placeholder="Nombre de usuario"><br>
                <input type="password" id="loginPassword" placeholder="Contraseña"><br>
                <button onclick="login()">Iniciar Sesión</button>
            </div>
            <p id="authMessage"></p>
        </div>

        <div class="messaging-section hidden" id="msgSection">
            <h2>Bienvenido <span id="currentUser"></span></h2>
            <p>ID: <span id="userId"></span></p>
            <input type="text" id="newContact" placeholder="Agregar contacto (nombre de usuario)"><br>
            <button onclick="addContact()">Agregar Contacto</button>
            <p id="contactStatus"></p>
            <div class="contacts" id="contacts"></div>
            <div class="messages" id="messages"></div>
            <textarea id="messageContent" placeholder="Escribe tu mensaje"></textarea><br>
            <button onclick="sendMessage()">Enviar Mensaje</button>
            <p id="messageStatus"></p>
        </div>

        <div class="settings-section hidden" id="settingsSection">
            <h2>Configuración</h2>
            <input type="text" id="displayName" placeholder="Nuevo nombre visible"><br>
            <input type="file" id="profilePicture" accept="image/*"><br>
            <button onclick="updateProfile()">Actualizar Perfil</button>
            <p id="settingsStatus"></p>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://uvmessages-production.up.railway.app';
        let currentUser = null;
        let selectedContact = null;

        window.onload = function() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                console.log('Usuario cargado desde localStorage:', currentUser);
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('msgSection').classList.remove('hidden');
                document.getElementById('openbtn').style.display = 'block';
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('currentUser').textContent = currentUser.displayName || '[Nombre no definido]';
                document.getElementById('userId').textContent = currentUser.id;
                loadContacts();
            }
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            if (sidebar.style.width === '250px') {
                sidebar.style.width = '0';
                main.style.marginLeft = '0';
            } else {
                sidebar.style.width = '250px';
                main.style.marginLeft = '250px';
            }
        }

        function showMessaging() {
            document.getElementById('msgSection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
        }

        function showSettings() {
            document.getElementById('msgSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.remove('hidden');
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const messageElement = document.getElementById('authMessage');

            console.log('Registrando usuario:', { username, password });

            if (!username || !password) {
                messageElement.textContent = 'Completa ambos campos';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, displayName: username })
                });
                const data = await response.json();
                console.log('Respuesta de registro:', data);

                if (response.ok) {
                    messageElement.textContent = `Usuario creado. Tu ID es: ${data.user.id}`;
                } else {
                    messageElement.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al registrar:', error);
                messageElement.textContent = 'Error al conectar con el servidor';
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageElement = document.getElementById('authMessage');

            console.log('Iniciando sesión:', { username, password });

            if (!username || !password) {
                messageElement.textContent = 'Completa ambos campos';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/users`);
                const users = await response.json();
                console.log('Usuarios obtenidos:', users);
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    currentUser = { 
                        id: user.id, 
                        username: user.username, 
                        displayName: user.displayName || user.username || '[Nombre no definido]', 
                        profilePicture: user.profilePicture ? `${BASE_URL}${user.profilePicture}` : 'https://via.placeholder.com/40'
                    };
                    console.log('Usuario logueado con datos procesados:', currentUser);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('msgSection').classList.remove('hidden');
                    document.getElementById('openbtn').style.display = 'block';
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = currentUser.displayName;
                    document.getElementById('userId').textContent = currentUser.id;
                    await loadContacts();
                } else {
                    messageElement.textContent = 'Usuario o contraseña incorrectos';
                }
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                messageElement.textContent = 'Error al conectar con el servidor';
            }
        }

        function logout() {
            console.log('Cerrando sesión');
            currentUser = null;
            selectedContact = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('msgSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('openbtn').style.display = 'none';
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('sidebar').style.width = '0';
            document.getElementById('main').style.marginLeft = '0';
            document.getElementById('authMessage').textContent = '';
            document.getElementById('contactStatus').textContent = '';
            document.getElementById('messageStatus').textContent = '';
        }

        async function addContact() {
            if (!currentUser) return;

            const contactId = document.getElementById('newContact').value;
            const statusElement = document.getElementById('contactStatus');

            console.log('Agregando contacto:', { userId: currentUser.id, contactId });

            if (!contactId) {
                statusElement.textContent = 'Ingresa un nombre de usuario';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/contacts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, contactId })
                });
                const data = await response.json();
                console.log('Respuesta de agregar contacto:', data);

                if (response.ok) {
                    statusElement.textContent = 'Contacto agregado';
                    document.getElementById('newContact').value = '';
                    await loadContacts();
                } else {
                    statusElement.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al agregar contacto:', error);
                statusElement.textContent = 'Error al conectar con el servidor';
            }
        }

        async function loadContacts() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${BASE_URL}/api/contacts?userId=${currentUser.id}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al cargar contactos');
                }
                const contacts = await response.json();
                const contactsDiv = document.getElementById('contacts');
                contactsDiv.innerHTML = '';

                console.log('Contactos cargados:', contacts);

                if (contacts.length === 0) {
                    contactsDiv.innerHTML = '<p>No tienes contactos aún.</p>';
                    return;
                }

                contacts.forEach(contact => {
                    const profilePic = contact.profilePicture ? `${BASE_URL}${contact.profilePicture}` : 'https://via.placeholder.com/40';
                    const displayName = contact.displayName || contact.username || '[Nombre no definido]';
                    console.log('Procesando contacto:', { id: contact.id, displayName, profilePic });
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact';
                    contactElement.innerHTML = `
                        <img src="${profilePic}" alt="${displayName}" onerror="this.src='https://via.placeholder.com/40'">
                        <span>${displayName}</span>
                        ${contact.unreadCount > 0 ? `<span class="notification">${contact.unreadCount}</span>` : ''}
                    `;
                    contactElement.onclick = () => {
                        selectedContact = contact.id;
                        console.log('Contacto seleccionado:', selectedContact);
                        updateMessages();
                        markMessagesAsRead();
                    };
                    contactsDiv.appendChild(contactElement);
                });
            } catch (error) {
                console.error('Error al cargar contactos:', error);
                document.getElementById('contactStatus').textContent = `Error: ${error.message}`;
            }
        }

        async function sendMessage() {
            if (!currentUser || !selectedContact) {
                document.getElementById('messageStatus').textContent = 'Selecciona un contacto primero';
                return;
            }

            const content = document.getElementById('messageContent').value;
            const messageStatus = document.getElementById('messageStatus');

            console.log('Enviando mensaje:', { senderId: currentUser.id, recipientId: selectedContact, content });

            if (!content) {
                messageStatus.textContent = 'Escribe un mensaje';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        senderId: currentUser.id,
                        recipientId: selectedContact,
                        content: content
                    })
                });
                const data = await response.json();
                console.log('Respuesta de enviar mensaje:', data);

                if (response.ok) {
                    messageStatus.textContent = 'Mensaje enviado';
                    document.getElementById('messageContent').value = '';
                    await updateMessages();
                    await loadContacts();
                } else {
                    messageStatus.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                messageStatus.textContent = 'Error al conectar con el servidor';
            }
        }

        async function updateMessages() {
            if (!currentUser || !selectedContact) return;

            try {
                const response = await fetch(`${BASE_URL}/api/messages?userId=${currentUser.id}&contactId=${selectedContact}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al obtener mensajes');
                }
                const messages = await response.json();
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                console.log('Mensajes cargados:', messages);

                messages.forEach(msg => {
                    const isSent = msg.senderId === currentUser.id;
                    const profilePic = isSent ? 
                        (currentUser.profilePicture || 'https://via.placeholder.com/30') : 
                        (msg.senderPicture ? `${BASE_URL}${msg.senderPicture}` : 'https://via.placeholder.com/30');
                    const displayName = isSent ? 
                        (currentUser.displayName || currentUser.username || '[Nombre no definido]') : 
                        (msg.senderDisplayName || msg.senderId || '[Nombre no definido]');
                    console.log('Procesando mensaje:', { id: msg.id, isSent, displayName, profilePic });
                    const msgElement = document.createElement('div');
                    msgElement.className = `message ${isSent ? 'sent' : 'received'}`;
                    msgElement.innerHTML = `
                        <img src="${profilePic}" alt="${displayName}" onerror="this.src='https://via.placeholder.com/30'">
                        <span>${displayName}: ${msg.content} (${new Date(msg.timestamp).toLocaleString()})</span>
                    `;
                    messagesDiv.appendChild(msgElement);
                });

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error al actualizar mensajes:', error);
                document.getElementById('messageStatus').textContent = `Error: ${error.message}`;
            }
        }

        async function markMessagesAsRead() {
            if (!currentUser || !selectedContact) return;

            try {
                const response = await fetch(`${BASE_URL}/api/messages/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, contactId: selectedContact })
                });
                const data = await response.json();
                console.log('Mensajes marcados como leídos:', data);
                await loadContacts();
            } catch (error) {
                console.error('Error al marcar mensajes como leídos:', error);
            }
        }

        async function updateProfile() {
            if (!currentUser) return;

            const displayName = document.getElementById('displayName').value;
            const profilePicture = document.getElementById('profilePicture').files[0];
            const statusElement = document.getElementById('settingsStatus');

            console.log('Actualizando perfil:', { displayName, hasFile: !!profilePicture });

            const formData = new FormData();
            formData.append('userId', currentUser.id);
            formData.append('displayName', displayName || currentUser.displayName);
            if (profilePicture) formData.append('profilePicture', profilePicture);

            try {
                const response = await fetch(`${BASE_URL}/api/upload-profile-picture`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                console.log('Respuesta de actualizar perfil:', data);

                if (response.ok) {
                    statusElement.textContent = 'Perfil actualizado';
                    currentUser.displayName = data.user.displayName;
                    currentUser.profilePicture = data.user.profilePicture ? `${BASE_URL}${data.user.profilePicture}` : null;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('currentUser').textContent = currentUser.displayName;
                    await loadContacts();
                    if (selectedContact) await updateMessages();
                } else {
                    statusElement.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al actualizar perfil:', error);
                statusElement.textContent = 'Error al conectar con el servidor';
            }
        }

        setInterval(() => {
            if (currentUser) loadContacts();
            if (currentUser && selectedContact) updateMessages();
        }, 5000);
    </script>
</body>
</html>
